class WE{constructor(rootId,node,dpi=2,helpersSize=10){this.helpersSize=helpersSize,this.helpers=[],this.minsize=20,this.node=node,this.dpi=dpi,this.root=document.getElementById(rootId),this.canvas=document.createElement("canvas"),this.hEl=document.createElement("input"),this.wEl=document.createElement("input"),this.tip=document.createElement("span"),this.colEl=[],this.rowEl=[],this.ctx=null,this.snapMode=!0}calcAvailableSpace(dir,index){let spaceLeft=0;var fixedSize=this.helpers.reduce((acc,helper,i)=>{i!=index&&helper.dir==dir&&("text"==helper.type?this.minsize:helper.value)},0);return spaceLeft="col"==dir?this.node.params.w-fixedSize:this.node.params.h-fixedSize}parseParam(v){var dir=v.size.substring(0,v.size.indexOf("-")),v=v.size.substring(parseInt(v.size.indexOf("-")+1,v.size.length));if(this.node.params[dir][v])return[this.node.params[dir][v],dir,v];console.warn("WRONG PARAMETER: dir "+dir+" index "+v)}calcOffset(){this.node.oldOffsetX=this.node.offsetX,this.node.oldOffsetY=this.node.offsetY,this.node.offsetX=(this.canvas.width-(this.node.geom.x2-this.node.geom.x1))/2,this.node.offsetY=(this.canvas.height-(this.node.geom.y2-this.node.geom.y1))/2}scaleGeometry(node){for(var key in this.node.factor||(this.node.factor=this.node.dpi),node.geom)node.geom[key]*=this.node.factor;node.child&&node.child.forEach(e=>this.scaleGeometry(e))}getArea(){let res={w:[],h:[],area:0};var fixedCol=this.node.params.w-this.node.params.col.reduce((acc,v)=>acc+v,0),fixedRow=this.node.params.h-this.node.params.row.reduce((acc,v)=>acc+v,0);let autoCol=fixedCol,autoRow=fixedRow;return this.node.params.col.length&&this.node.params.colOrder&&(autoCol/=this.node.params.colOrder.length-this.node.params.col.length),this.node.params.rowOrder&&this.node.params.row.length&&(autoRow/=this.node.params.rowOrder.length-this.node.params.row.length),this.node.params.areas?this.node.params.areas.forEach((coords,i)=>{var dir=coords.w.split("-")[0],index=coords.w.split("-")[1];"x"==index?res.w.push(autoCol):res.w.push(this.node.params[dir][index]||0),dir=coords.h.split("-")[0],"x"==(index=coords.h.split("-")[1])?res.h.push(autoRow):res.h.push(this.node.params[dir][index]||0),res.area+=res.w[i]*res.h[i]}):console.error("No area data specified!"),res}calcNode(node,parent=null,i=0){if(node.bb={x1:0,y1:0,x2:0,y2:0},node.geom={...node.bb},!node.dir&&node.child&&(node.dir="h"),!node.gap&&node.child&&(node.gap=0),node.pd?1==node.pd.length&&(node.pd=new Array(4).fill(node.pd[0])):node.pd=[0,0,0,0],node){if(parent?("h"==parent.dir?(parent.geom.x2,parent.geom.x1,node.bb.y1=parent.geom.y1,node.bb.y2=parent.geom.y2,0<i?node.bb.x1+=parent.child[i-1].bb.x2:node.bb.x1=parent.geom.x1,"string"==typeof node.size?node.bb.x2=node.bb.x1+this.parseParam(node)[0]:node.bb.x2=node.bb.x1+parent.autoSize):(parent.geom.y2,parent.geom.y1,node.bb.x1=parent.geom.x1,node.bb.x2=parent.geom.x2,0<i?node.bb.y1+=parent.child[i-1].bb.y2:node.bb.y1=parent.geom.y1,"string"==typeof node.size?node.bb.y2=node.bb.y1+this.parseParam(node)[0]:node.bb.y2=node.bb.y1+parent.autoSize),node.geom={...node.bb},1<parent.child.length?"h"==parent.dir?(node.geom.y1+=parent.pd[0],node.geom.y2-=parent.pd[2],0==i&&(node.geom.x1+=parent.pd[1]),i==parent.child.length-1&&(node.geom.x2-=parent.pd[3]),0<i&&(node.geom.x1+=parent.gap/2),i<parent.child.length-1&&(node.geom.x2-=parent.gap/2)):(node.geom.x1+=parent.pd[1],node.geom.x2-=parent.pd[3],0==i&&(node.geom.y1+=parent.pd[0]),i==parent.child.length-1&&(node.geom.y2-=parent.pd[2]),0<i&&(node.geom.y1+=parent.gap/2),i<parent.child.length-1&&(node.geom.y2-=parent.gap/2)):(node.geom.x1+=parent.pd[3],node.geom.x2-=parent.pd[1],node.geom.y1+=parent.pd[0],node.geom.y2-=parent.pd[2])):(node.bb={x1:0,y1:0,x2:this.node.params.w,y2:this.node.params.h},node.geom={...node.bb}),node.child){let fixedSize=0,affectedChild=node.child.length;node.child.forEach(v=>{"string"==typeof v.size&&(fixedSize+=this.parseParam(v)[0],--affectedChild)}),"h"==node.dir?node.autoSize=(node.geom.x2-node.geom.x1-fixedSize)/affectedChild:node.autoSize=(node.geom.y2-node.geom.y1-fixedSize)/affectedChild,node.child&&node.child.forEach((e,j)=>this.calcNode(e,node,j))}}else console.error("NO NODE OBJECT! Failed to CalcNode")}drawHelpers(){this.ctx.strokeStyle="#000",this.ctx.fillStyle="#000",this.ctx.lineWidth=1.5*this.dpi,this.ctx.font=`bold ${22*this.dpi}px sans-serif`,this.ctx.textAlign="center",this.ctx.beginPath();let multiplier=1;var textX,textY;this.helpers.length&&(multiplier*=2),this.ctx.moveTo(this.node.geom.x1,this.node.geom.y1),this.ctx.lineTo(this.node.geom.x1,this.node.geom.y1-this.helpersSize*multiplier),this.ctx.moveTo(this.node.geom.x2,this.node.geom.y1),this.ctx.lineTo(this.node.geom.x2,this.node.geom.y1-this.helpersSize*multiplier),this.ctx.moveTo(this.node.geom.x1,this.node.geom.y1-this.helpersSize*multiplier*.95),this.ctx.lineTo(this.node.geom.x2,this.node.geom.y1-this.helpersSize*multiplier*.95),this.ctx.moveTo(this.node.geom.x2,this.node.geom.y1),this.ctx.lineTo(this.node.geom.x2+this.helpersSize*multiplier,this.node.geom.y1),this.ctx.moveTo(this.node.geom.x2,this.node.geom.y2),this.ctx.lineTo(this.node.geom.x2+this.helpersSize*multiplier,this.node.geom.y2),this.ctx.moveTo(this.node.geom.x2+this.helpersSize*multiplier*.95,this.node.geom.y1),this.ctx.lineTo(this.node.geom.x2+this.helpersSize*multiplier*.95,this.node.geom.y2),this.snapMode&&(textX=(this.node.geom.x2-this.node.geom.x1)/2,textY=this.node.geom.y1-this.helpersSize*multiplier,this.ctx.font=`bold ${22*this.dpi}px sans-serif`,this.ctx.fillText(parseFloat(this.node.params.w.toFixed(2)),textX,textY),this.ctx.fillStyle="#000",textX=this.node.geom.x2+this.helpersSize*(.65*multiplier),textY=(this.node.geom.y2-this.node.geom.y1)/2,this.ctx.font=`bold ${22*this.dpi}px sans-serif`,this.ctx.fillText(parseFloat(this.node.params.h.toFixed(2)),textX,textY),this.ctx.fillStyle="#000"),this.helpers.forEach((helper,i)=>{var textX,textY;if("col"==helper.dir&&(this.ctx.moveTo(helper.pos*this.node.factor,this.node.geom.y1),this.ctx.lineTo(helper.pos*this.node.factor,this.node.geom.y1-.95*this.helpersSize),this.ctx.moveTo((helper.pos+helper.value)*this.node.factor,this.node.geom.y1),this.ctx.lineTo((helper.pos+helper.value)*this.node.factor,this.node.geom.y1-.95*this.helpersSize),this.ctx.moveTo(helper.pos*this.node.factor,this.node.geom.y1-.85*this.helpersSize),this.ctx.lineTo((helper.pos+helper.value)*this.node.factor,this.node.geom.y1-.85*this.helpersSize),"text"!=helper.type&&!this.snapMode||(textX=(helper.pos+helper.value/2)*this.node.factor,textY=this.node.geom.y1-this.helpersSize/2+20,helper.value<this.minsize+1&&!this.snapMode?(this.ctx.fillStyle="#ce2020",this.ctx.font=`bold ${22*this.dpi}px sans-serif`,this.ctx.fillText(parseFloat(helper.value.toFixed(2)),textX,textY-10),this.ctx.font=`bold ${12*this.dpi}px sans-serif`,this.ctx.fillText("Min."+this.minsize,textX,10+textY)):(this.ctx.font=`bold ${22*this.dpi}px sans-serif`,this.ctx.fillText(parseFloat(helper.value.toFixed(2)),textX,textY)),this.ctx.fillStyle="#000")),"row"==helper.dir&&(this.ctx.moveTo(this.node.geom.x2,helper.pos*this.node.factor),this.ctx.lineTo(this.node.geom.x2+.95*this.helpersSize,helper.pos*this.node.factor),this.ctx.moveTo(this.node.geom.x2,(helper.pos+helper.value)*this.node.factor),this.ctx.lineTo(this.node.geom.x2+.95*this.helpersSize,(helper.pos+helper.value)*this.node.factor),this.ctx.moveTo(this.node.geom.x2+.85*this.helpersSize,helper.pos*this.node.factor),this.ctx.lineTo(this.node.geom.x2+.85*this.helpersSize,(helper.pos+helper.value)*this.node.factor),"text"==helper.type||this.snapMode)){let textX=this.node.geom.x2+this.helpersSize/2.4,textY=(helper.pos+helper.value/2)*this.node.factor+4*this.node.factor;helper.value<this.minsize+1&&!this.snapMode?(this.ctx.fillStyle="#ce2020",this.ctx.font=`bold ${22*this.dpi}px sans-serif`,this.ctx.fillText(parseFloat(helper.value.toFixed(2)),textX,textY-10),this.ctx.font=`bold ${12*this.dpi}px sans-serif`,this.ctx.fillText("Min."+this.minsize,textX,10+textY)):(this.ctx.font=`bold ${22*this.dpi}px sans-serif`,this.ctx.fillText(parseFloat(helper.value.toFixed(2)),textX,textY))}}),this.ctx.closePath(),this.ctx.stroke()}setRelief(el=this.hEl){el.classList.remove("urgent"),this.tip.style.display="none"}setUrgent(el=this.hEl,type="min",value=100500){let msgStr="";el.classList.add("urgent"),this.tip.style.top=el.style.top,this.tip.style.left=el.style.left,this.tip.style.display="block",msgStr=msgStr+("min"==type?"Min. ":"Max. ")+value,this.tip.innerHTML=msgStr}stash(){this.backNode=JSON.parse(JSON.stringify(this.node)),this.backHelpers=JSON.parse(JSON.stringify(this.helpers))}undo(){this.node=JSON.parse(JSON.stringify(this.backNode)),this.helpers=JSON.parse(JSON.stringify(this.backHelpers))}resetInputs(){this.hEl.value=this.node.params.h,this.wEl.value=this.node.params.w,this.helpers.forEach((helper,i)=>{"input"==helper.type&&(this[helper.dir+"El"][helper.index].value=helper.value)})}getSnapshot(){this.snapMode=!0,this.update();var blobPromise=new Promise(resolve=>{this.canvas.toBlob(blob=>{resolve(blob)})});return this.snapMode=!1,this.update(),blobPromise}getSnapshotBase64(){this.snapMode=!0,this.update();var b64=this.canvas.toDataURL("image/png");return this.snapMode=!1,this.update(),b64}checkBounds(){let bounds=!1;return this.helpers.forEach((helper,i)=>{helper.value<this.minsize?(this.undo(),bounds=!0,this.resetInputs(),this.helpers[i].urgent=!0):this.helpers[i].urgent=!1}),bounds}validate(el,value,min,max){min=min||this.minsize;let res=0;return value<(max=max||1e3)&&min<value?(res=value,this.setRelief(el)):value<=min?(setTimeout(()=>{this.setUrgent(el,"min",min)},50),res=min):max<=value&&(setTimeout(()=>{this.setUrgent(el,"max",max)},50),res=max),res=parseInt(res),el.value=res}setParam(param="height",value=100,limit=null){var dir;this.stash(),"height"==param?limit?"max"==limit?this.hEl.max=this.params.maxh=value:this.hEl.min=this.params.minh=value:this.node.params.h=this.validate(this.hEl,value,this.node.params.minh,this.node.params.maxh):"width"==param?limit?"max"==limit?this.wEl.max=this.params.maxw=value:this.wEl.min=this.params.minw=value:this.node.params.w=this.validate(this.wEl,value,this.node.params.minw,this.node.params.maxw):(dir=param.split("-")[0],param=param.split("-")[1],"col"==dir&&(limit?"max"==limit?this.colEl[param].max=this.params.maxCol[param]=value:this.colEl[param].min=this.params.minCol[param]=value:this.node.params.col[param]=this.validate(this.colEl[param],value,this.node.params.minCol[param],this.node.params.maxCol[param])),"row"==dir&&(limit?"max"==limit?this.rowEl[param].max=this.params.maxRow[param]=value:this.rowEl[param].min=this.params.minRow[param]=value:this.node.params.row[param]=this.validate(this.rowEl[param],value,this.node.params.minRow[param],this.node.params.maxRow[param]))),this.update(),this.checkBounds();this.update(),console.log(this)}updateInputs(){let inputOffsetX=this.node.params.w*this.node.factor/(2*this.dpi),inputOffsetY=this.node.params.h*this.node.factor/(2*this.dpi),multiplier=1;this.helpers.length||(multiplier=.5),this.wEl.style.top=`calc(50% - ${inputOffsetY+this.helpersSize*multiplier}px)`,this.wEl.style.left=`calc(50% - ${inputOffsetX-this.node.params.w*(this.node.factor/this.dpi)/2}px)`,this.hEl.style.top="50%",this.hEl.style.left=`calc(50% - ${inputOffsetX-this.node.params.w/this.dpi*this.node.factor-this.helpersSize*multiplier}px`,this.helpers.forEach((helper,i)=>{var j;"input"==helper.type&&(j=helper.index,"col"==helper.dir&&this.colEl[j]&&(this.colEl[j].style.left=`calc(50% - ${inputOffsetX-(this.helpers[i].pos+this.helpers[i].value/2)*this.node.factor/2}px)`,this.colEl[j].style.top=`calc(50% - ${inputOffsetY+this.helpersSize/2.2}px)`),"row"==helper.dir)&&this.rowEl[j]&&(this.rowEl[j].style.top=`calc(50% - ${inputOffsetY-(this.helpers[i].pos+this.helpers[i].value/2)*this.node.factor/2}px)`,this.rowEl[j].style.left=`calc(50% + ${inputOffsetX+this.helpersSize/2.4}px)`)})}initInputs(){this.wEl.value=this.node.params.w||10,this.wEl.setAttribute("id","we-width"),this.wEl.type="number",this.hEl.value=this.node.params.h||10,this.hEl.setAttribute("id","we-height"),this.hEl.type="number",isNaN(this.node.params.maxh)||(this.hEl.max=this.node.params.maxh),isNaN(this.node.params.minh)||(this.hEl.min=this.node.params.minh),isNaN(this.node.params.maxw)||(this.wEl.max=this.node.params.maxw),isNaN(this.node.params.minw)||(this.wEl.min=this.node.params.minw),this.tip.classList.add("tooltip"),this.tip.style.display="none",this.root.appendChild(this.hEl),this.root.appendChild(this.wEl),this.root.appendChild(this.tip),this.colEl.forEach(el=>{el.remove()}),this.rowEl.forEach(el=>{el.remove()}),this.colEl=[],this.rowEl=[],this.node.params.row&&this.node.params.row.forEach((row,i)=>{this.rowEl.push(document.createElement("input")),this.rowEl[i].value=row,this.rowEl[i].type="number",this.rowEl[i].setAttribute("id","we-row-"+i),this.rowEl[i].addEventListener("blur",()=>{this.setRelief(this.rowEl[i])}),this.rowEl[i].addEventListener("change",el=>{this.setParam("row-"+i,el.target.value)}),this.root.appendChild(this.rowEl[i])}),this.node.params.col&&this.node.params.col.forEach((col,i)=>{this.colEl.push(document.createElement("input")),this.colEl[i].value=col,this.colEl[i].type="number",this.colEl[i].setAttribute("id","we-col-"+i),this.colEl[i].addEventListener("blur",()=>{this.setRelief(this.colEl[i])}),this.colEl[i].addEventListener("change",el=>{this.setParam("col-"+i,el.target.value)}),this.root.appendChild(this.colEl[i])}),this.hEl.addEventListener("blur",()=>{this.setRelief(this.hEl)}),this.wEl.addEventListener("blur",()=>{this.setRelief(this.wEl)}),this.hEl.addEventListener("change",el=>{this.setParam("height",el.target.value)}),this.wEl.addEventListener("change",el=>{this.setParam("width",el.target.value)})}calcHelpers(){this.helpers=[],0<this.node.params.col.length&&(this.node.params.colOrder||(this.node.params.colOrder=Array.from(Array(this.node.params.col.length).keys()),this.node.params.colOrder.push(-1))),0<this.node.params.row.length&&(this.node.params.rowOrder||(this.node.params.rowOrder=Array.from(Array(this.node.params.row.length).keys()),this.node.params.rowOrder.push(-1))),this.node.params.colOrder&&this.node.params.colOrder.forEach((order,i)=>{var fixedSize,helper={dir:"col"};order<0?(helper.type="text",fixedSize=this.node.params.col.reduce((acc,v)=>acc+v,0),helper.value=(this.node.params.w-fixedSize)/(this.node.params.colOrder.length-this.node.params.col.length)):(helper.index=this.node.params.colOrder[i],helper.type="input",helper.value=this.node.params.col[order]);for(let k=helper.pos=0;k<i;k++)helper.pos+=this.helpers[k].value,helper.inputPos=helper.pos+helper.value/2;this.helpers.push(helper)}),this.node.params.rowOrder&&this.node.params.rowOrder.forEach((order,i)=>{var fixedSize,helper={dir:"row"};order<0?(helper.type="text",fixedSize=this.node.params.row.reduce((acc,v)=>acc+v,0),helper.value=(this.node.params.h-fixedSize)/(this.node.params.rowOrder.length-this.node.params.row.length)):(helper.index=this.node.params.rowOrder[i],helper.type="input",helper.value=this.node.params.row[order]);for(let k=helper.pos=0;k<i;k++)this.node.params.colOrder?helper.pos+=this.helpers[k+this.node.params.colOrder.length].value:helper.pos+=this.helpers[k].value,helper.inputPos=helper.pos+helper.value/2;this.helpers.push(helper)})}drawNode(node,firstEntry=0){if(this.ctx.strokeStyle="#000",this.ctx.lineWidth=1.5*this.dpi,this.ctx.fillStyle="#eee8e0",node.glass&&(this.ctx.fillStyle="#c0c8ef"),this.ctx.fillRect(node.geom.x1,node.geom.y1,node.geom.x2-node.geom.x1,node.geom.y2-node.geom.y1),node.borderless||this.ctx.strokeRect(node.geom.x1,node.geom.y1,node.geom.x2-node.geom.x1,node.geom.y2-node.geom.y1),node.child&&node.child.forEach(e=>this.drawNode(e,!1)),node.triangle){switch(this.ctx.beginPath(),node.triangle){case"right":this.ctx.moveTo(node.geom.x1,node.geom.y1),this.ctx.lineTo(node.geom.x2,node.geom.y2-(node.geom.y2-node.geom.y1)/2),this.ctx.lineTo(node.geom.x1,node.geom.y2);break;case"left":this.ctx.moveTo(node.geom.x2,node.geom.y1),this.ctx.lineTo(node.geom.x1,node.geom.y2-(node.geom.y2-node.geom.y1)/2),this.ctx.lineTo(node.geom.x2,node.geom.y2);break;case"bottom":this.ctx.moveTo(node.geom.x1,node.geom.y1),this.ctx.lineTo(node.geom.x2-(node.geom.x2-node.geom.x1)/2,node.geom.y2),this.ctx.lineTo(node.geom.x2,node.geom.y1);break;case"top":this.ctx.moveTo(node.geom.x1,node.geom.y2),this.ctx.lineTo(node.geom.x2-(node.geom.x2-node.geom.x1)/2,node.geom.y1),this.ctx.lineTo(node.geom.x2,node.geom.y2)}this.ctx.closePath(),this.ctx.stroke()}}updateCanvas(){this.canvas.width=this.root.clientWidth*this.dpi,this.canvas.height=this.root.clientHeight*this.dpi;this.node.invFactor;this.node.factor=Math.min(Math.floor(this.canvas.width/(this.node.params.w+80)),Math.floor(this.canvas.height/(this.node.params.h+80))),this.node.invFactor=Math.min(this.canvas.width,this.canvas.height)/100,this.helpersSize=2*this.hEl.clientHeight+10}update(){this.updateCanvas(),this.calcNode(this.node),this.scaleGeometry(this.node),this.calcOffset(this.node),this.calcHelpers(),this.render(),this.updateInputs()}render(){this.node&&(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.translate(this.node.offsetX,this.node.offsetY),this.ctx.restore(),this.drawNode(this.node),this.drawHelpers(),this.ctx.save())}init(){this.node?this.root?(this.root.appendChild(this.canvas),this.canvas.width=this.canvas.clientWidth*this.dpi,this.canvas.height=this.canvas.clientHeight*this.dpi,this.node.factor=Math.min(Math.floor(this.canvas.width/(this.node.params.w+80)),Math.floor(this.canvas.height/(this.node.params.h+80))),this.node.invFactor=10/this.node.factor,this.ctx=this.canvas.getContext("2d"),this.node.params.maxh||(this.node.params.maxh=1e3),this.node.params.minh||(this.node.params.minh=this.minsize),this.node.params.maxw||(this.node.params.maxw=1e3),this.node.params.minw||(this.node.params.minw=this.minsize),this.node.params.col||(this.node.params.col=[]),this.node.params.row||(this.node.params.row=[]),this.node.params.minCol||(this.node.params.minCol=[]),this.node.params.maxCol||(this.node.params.maxCol=[]),this.node.params.maxRow||(this.node.params.maxRow=[]),this.node.params.minRow||(this.node.params.minRow=[]),setTimeout(()=>{this.initInputs(),this.update(),this.stash()},80)):console.error("NO ROOT ELEMENT! Failed to init"):console.error("NO NODE OBJECT! Failed to init")}}