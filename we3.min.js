let win1={params:{h:90,w:200,col:[50,40,60],row:[]},pd:[4,4,4,4],gap:4,dir:"v",child:[{gap:4,pd:[4,4,4,4],dir:"h",child:[{size:"col-1"},{size:"col-2"},{}]},{},{size:"col-1"}]},win2={params:{h:150,w:178,minh:120,maxh:220,minw:150,maxw:240,col:[40,60],row:[100],colOrder:[-1,1,0],rowOrder:[-1,0]},pd:[2,2,2,2],gap:2,dir:"v",child:[{pd:[3,3,3,3],child:[{glass:!0}]},{size:"row-0",gap:2,borderless:!0,child:[{pd:[3,3,3,3],child:[{glass:!0,triangle:"right"}]},{size:"col-1",pd:[3,3,3,3],child:[{glass:!0}]},{size:"col-0",pd:[3,3,3,3],child:[{glass:!0,triangle:"left"}]}]}]};class WE{constructor(e,t,s=2,i=18){this.helpersSize=i,this.helpers=[],this.node=t,this.dpi=s,this.root=document.getElementById(e),this.canvas=document.createElement("canvas"),this.hEl=document.createElement("input"),this.wEl=document.createElement("input"),this.tip=document.createElement("span"),this.colEl=[],this.rowEl=[],this.ctx=null}parseParam(e){var t=e.size.substring(0,e.size.indexOf("-")),e=e.size.substring(parseInt(e.size.indexOf("-")+1,e.size.length));if(this.node.params[t][e])return[this.node.params[t][e],t,e];console.warn("WRONG PARAMETER: dir "+t+" index "+e)}calcOffset(){this.node.oldOffsetX=this.node.offsetX,this.node.oldOffsetY=this.node.offsetY,this.node.offsetX=(this.canvas.width-(this.node.geom.x2-this.node.geom.x1))/2,this.node.offsetY=(this.canvas.height-(this.node.geom.y2-this.node.geom.y1))/2}scaleGeometry(e){for(var t in this.node.factor||(this.node.factor=this.node.dpi),e.geom)e.geom[t]*=this.node.factor;e.child&&e.child.forEach(e=>this.scaleGeometry(e))}calcNode(i,e=null,t=0){if(i.bb={x1:0,y1:0,x2:0,y2:0},i.geom={...i.bb},!i.dir&&i.child&&(i.dir="h"),!i.gap&&i.child&&(i.gap=0),i.pd||(i.pd=[0,0,0,0]),i){if(e?("h"==e.dir?(e.geom.x2,e.geom.x1,i.bb.y1=e.geom.y1,i.bb.y2=e.geom.y2,0<t?i.bb.x1+=e.child[t-1].bb.x2:i.bb.x1=e.geom.x1,"string"==typeof i.size?i.bb.x2=i.bb.x1+this.parseParam(i)[0]:i.bb.x2=i.bb.x1+e.autoSize):(e.geom.y2,e.geom.y1,i.bb.x1=e.geom.x1,i.bb.x2=e.geom.x2,0<t?i.bb.y1+=e.child[t-1].bb.y2:i.bb.y1=e.geom.y1,"string"==typeof i.size?i.bb.y2=i.bb.y1+this.parseParam(i)[0]:i.bb.y2=i.bb.y1+e.autoSize),i.geom={...i.bb},1<e.child.length?"h"==e.dir?(i.geom.y1+=e.pd[0],i.geom.y2-=e.pd[2],0==t&&(i.geom.x1+=e.pd[1]),t==e.child.length-1&&(i.geom.x2-=e.pd[3]),0<t&&(i.geom.x1+=e.gap/2),t<e.child.length-1&&(i.geom.x2-=e.gap/2)):(i.geom.x1+=e.pd[1],i.geom.x2-=e.pd[3],0==t&&(i.geom.y1+=e.pd[0]),t==e.child.length-1&&(i.geom.y2-=e.pd[2]),0<t&&(i.geom.y1+=e.gap/2),t<e.child.length-1&&(i.geom.y2-=e.gap/2)):(i.geom.x1+=e.pd[3],i.geom.x2-=e.pd[1],i.geom.y1+=e.pd[0],i.geom.y2-=e.pd[2])):(i.bb={x1:0,y1:0,x2:this.node.params.w,y2:this.node.params.h},i.geom={...i.bb}),i.child){let t=0,s=i.child.length;i.child.forEach(e=>{"string"==typeof e.size&&(t+=this.parseParam(e)[0],--s)}),"h"==i.dir?i.autoSize=(i.geom.x2-i.geom.x1-t)/s:i.autoSize=(i.geom.y2-i.geom.y1-t)/s,i.child&&i.child.forEach((e,t)=>this.calcNode(e,i,t))}}else console.error("NO NODE OBJECT! Failed to CalcNode")}drawHelpers(){this.ctx.strokeStyle="#000",this.ctx.fillStyle="#000",this.ctx.lineWidth=1.5*this.dpi,this.ctx.font=`bold ${24*this.dpi}px sans-serif`,this.ctx.textAlign="center",this.ctx.beginPath();let e=1;this.helpers.length&&(e*=2),this.ctx.moveTo(this.node.geom.x1,this.node.geom.y1),this.ctx.lineTo(this.node.geom.x1,this.node.geom.y1-this.helpersSize*e),this.ctx.moveTo(this.node.geom.x2,this.node.geom.y1),this.ctx.lineTo(this.node.geom.x2,this.node.geom.y1-this.helpersSize*e),this.ctx.moveTo(this.node.geom.x1,this.node.geom.y1-this.helpersSize*e*.95),this.ctx.lineTo(this.node.geom.x2,this.node.geom.y1-this.helpersSize*e*.95),this.ctx.moveTo(this.node.geom.x2,this.node.geom.y1),this.ctx.lineTo(this.node.geom.x2+this.helpersSize*e,this.node.geom.y1),this.ctx.moveTo(this.node.geom.x2,this.node.geom.y2),this.ctx.lineTo(this.node.geom.x2+this.helpersSize*e,this.node.geom.y2),this.ctx.moveTo(this.node.geom.x2+this.helpersSize*e*.95,this.node.geom.y1),this.ctx.lineTo(this.node.geom.x2+this.helpersSize*e*.95,this.node.geom.y2),this.helpers.forEach((e,t)=>{var s,i;"col"==e.dir&&(this.ctx.moveTo(e.pos*this.node.factor,this.node.geom.y1),this.ctx.lineTo(e.pos*this.node.factor,this.node.geom.y1-.95*this.helpersSize),this.ctx.moveTo((e.pos+e.value)*this.node.factor,this.node.geom.y1),this.ctx.lineTo((e.pos+e.value)*this.node.factor,this.node.geom.y1-.95*this.helpersSize),this.ctx.moveTo(e.pos*this.node.factor,this.node.geom.y1-.85*this.helpersSize),this.ctx.lineTo((e.pos+e.value)*this.node.factor,this.node.geom.y1-.85*this.helpersSize),"text"==e.type)&&(s=(e.pos+e.value/2)*this.node.factor,i=this.node.geom.y1-this.helpersSize/2+4*this.node.factor,this.ctx.fillText(e.value,s,i)),"row"==e.dir&&(this.ctx.moveTo(this.node.geom.x2,e.pos*this.node.factor),this.ctx.lineTo(this.node.geom.x2+.95*this.helpersSize,e.pos*this.node.factor),this.ctx.moveTo(this.node.geom.x2,(e.pos+e.value)*this.node.factor),this.ctx.lineTo(this.node.geom.x2+.95*this.helpersSize,(e.pos+e.value)*this.node.factor),this.ctx.moveTo(this.node.geom.x2+.85*this.helpersSize,e.pos*this.node.factor),this.ctx.lineTo(this.node.geom.x2+.85*this.helpersSize,(e.pos+e.value)*this.node.factor),"text"==e.type)&&(s=this.node.geom.x2+this.helpersSize/2.4,i=(e.pos+e.value/2)*this.node.factor+4*this.node.factor,this.ctx.fillText(e.value,s,i))}),this.ctx.closePath(),this.ctx.stroke()}setRelief(e=this.hEl){e.classList.remove("urgent"),this.tip.style.display="none"}setUrgent(e=this.hEl,t="min",s=100500){let i="";e.classList.add("urgent"),this.tip.style.top=e.style.top,this.tip.style.left=e.style.left,this.tip.style.display="block",i=i+("min"==t?"Min. ":"Max. ")+s,this.tip.innerHTML=i}validate(e,t,s,i){s=s||10;let o=0;return t<(i=i||1e3)&&s<t?(o=t,this.setRelief(e)):t<=s?(setTimeout(()=>{this.setUrgent(e,"min",s)},50),o=s):i<=t&&(setTimeout(()=>{this.setUrgent(e,"max",i)},50),o=i),o=parseInt(o),e.value=o}setParam(e="height",t=100,s=null){var i;"height"==e?s?"max"==s?this.hEl.max=this.params.maxh=t:this.hEl.min=this.params.minh=t:this.node.params.h=this.validate(this.hEl,t,this.node.params.minh,this.node.params.maxh):"width"==e?s?"max"==s?this.wEl.max=this.params.maxw=t:this.wEl.min=this.params.minw=t:this.node.params.w=this.validate(this.wEl,t,this.node.params.minw,this.node.params.maxw):(i=e.split("-")[0],e=e.split("-")[1],"col"==i&&(s?"max"==s?this.colEl[e].max=this.params.maxCol[e]=t:this.colEl[e].min=this.params.minCol[e]=t:this.node.params.col[e]=this.validate(this.colEl[e],t,this.node.params.minCol[e],this.node.params.maxCol[e])),"row"==i&&(s?"max"==s?this.rowEl[e].max=this.params.maxRow[e]=t:this.rowEl[e].min=this.params.minRow[e]=t:this.node.params.row[e]=this.validate(this.rowEl[e],t,this.node.params.minRow[e],this.node.params.maxRow[e]))),this.update()}updateInputs(){let i=this.node.params.w*this.node.factor/(2*this.dpi),o=this.node.params.h*this.node.factor/(2*this.dpi);this.wEl.style.top=`calc(50% - ${o+this.helpersSize}px)`,this.wEl.style.left=`calc(50% - ${i-this.node.params.w*(this.node.factor/this.dpi)/2}px)`,this.hEl.style.top="50%",this.hEl.style.left=`calc(50% - ${i-this.node.params.w/this.dpi*this.node.factor-this.helpersSize}px`,this.helpers.forEach((e,t)=>{var s;"input"==e.type&&(s=e.index,"col"==e.dir&&(this.colEl[s].style.left=`calc(50% - ${i-(this.helpers[t].pos+this.helpers[t].value/2)*this.node.factor/2}px)`,this.colEl[s].style.top=`calc(50% - ${o+this.helpersSize/2.2}px)`),"row"==e.dir)&&(this.rowEl[s].style.top=`calc(50% - ${o-(this.helpers[t].pos+this.helpers[t].value/2)*this.node.factor/2}px)`,this.rowEl[s].style.left=`calc(50% + ${i+this.helpersSize/2.4}px)`)})}initInputs(){this.wEl.value=this.node.params.w||10,this.wEl.setAttribute("id","we-width"),this.wEl.type="number",this.hEl.value=this.node.params.h||10,this.hEl.setAttribute("id","we-height"),this.hEl.type="number",isNaN(this.node.params.maxh)||(this.hEl.max=this.node.params.maxh),isNaN(this.node.params.minh)||(this.hEl.min=this.node.params.minh),isNaN(this.node.params.maxw)||(this.wEl.max=this.node.params.maxw),isNaN(this.node.params.minw)||(this.wEl.min=this.node.params.minw),this.tip.classList.add("tooltip"),this.tip.style.display="none",this.root.appendChild(this.hEl),this.root.appendChild(this.wEl),this.root.appendChild(this.tip),this.colEl.forEach(e=>{e.remove()}),this.rowEl.forEach(e=>{e.remove()}),this.colEl=[],this.rowEl=[],this.node.params.row.forEach((e,t)=>{this.rowEl.push(document.createElement("input")),this.rowEl[t].value=e,this.rowEl[t].type="number",this.rowEl[t].setAttribute("id","we-row-"+t),this.rowEl[t].addEventListener("blur",()=>{this.setRelief(this.rowEl[t])}),this.rowEl[t].addEventListener("change",e=>{this.setParam("row-"+t,e.target.value)}),this.root.appendChild(this.rowEl[t])}),this.node.params.col.forEach((e,t)=>{this.colEl.push(document.createElement("input")),this.colEl[t].value=e,this.colEl[t].type="number",this.colEl[t].setAttribute("id","we-col-"+t),this.colEl[t].addEventListener("blur",()=>{this.setRelief(this.colEl[t])}),this.colEl[t].addEventListener("change",e=>{this.setParam("col-"+t,e.target.value)}),this.root.appendChild(this.colEl[t])}),this.hEl.addEventListener("blur",()=>{this.setRelief(this.hEl)}),this.wEl.addEventListener("blur",()=>{this.setRelief(this.wEl)}),this.hEl.addEventListener("change",e=>{this.setParam("height",e.target.value)}),this.wEl.addEventListener("change",e=>{this.setParam("width",e.target.value)})}calcHelpers(){this.helpers=[],0<this.node.params.col.length&&(this.node.params.colOrder||(this.node.params.colOrder=Array.from(Array(this.node.params.col.length).keys()),this.node.params.colOrder.push(-1))),0<this.node.params.row.length&&(this.node.params.rowOrder||(this.node.params.rowOrder=Array.from(Array(this.node.params.row.length).keys()),this.node.params.rowOrder.push(-1))),this.node.params.colOrder.forEach((e,t)=>{var s,i={dir:"col"};e<0?(i.type="text",s=this.node.params.col.reduce((e,t)=>e+t,0),i.value=(this.node.params.w-s)/(this.node.params.colOrder.length-this.node.params.col.length)):(i.index=this.node.params.colOrder[t],i.type="input",i.value=this.node.params.col[e]);for(let e=i.pos=0;e<t;e++)i.pos+=this.helpers[e].value,i.inputPos=i.pos+i.value/2;this.helpers.push(i)}),this.node.params.rowOrder.forEach((e,t)=>{var s,i={dir:"row"};e<0?(i.type="text",s=this.node.params.row.reduce((e,t)=>e+t,0),i.value=(this.node.params.h-s)/(this.node.params.rowOrder.length-this.node.params.row.length)):(i.index=this.node.params.rowOrder[t],i.type="input",i.value=this.node.params.row[e]);for(let e=i.pos=0;e<t;e++)i.pos+=this.helpers[e+this.node.params.colOrder.length].value,i.inputPos=i.pos+i.value/2;this.helpers.push(i)})}drawNode(e,t=!0){if(t&&(this.ctx.translate(this.node.offsetX,this.node.offsetY),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)),this.ctx.strokeStyle="#000",this.ctx.lineWidth=1.5*this.dpi,this.ctx.fillStyle=`hsl(${e.bb.x2/e.bb.y2*360+3*e.bb.x1}deg, 60%, 70%)`,this.ctx.fillRect(e.geom.x1,e.geom.y1,e.geom.x2-e.geom.x1,e.geom.y2-e.geom.y1),e.borderless||this.ctx.strokeRect(e.geom.x1,e.geom.y1,e.geom.x2-e.geom.x1,e.geom.y2-e.geom.y1),e.child&&e.child.forEach(e=>this.drawNode(e,!1)),e.triangle){switch(this.ctx.beginPath(),e.triangle){case"right":this.ctx.moveTo(e.geom.x1,e.geom.y1),this.ctx.lineTo(e.geom.x2,e.geom.y2-(e.geom.y2-e.geom.y1)/2),this.ctx.lineTo(e.geom.x1,e.geom.y2);break;case"left":this.ctx.moveTo(e.geom.x2,e.geom.y1),this.ctx.lineTo(e.geom.x1,e.geom.y2-(e.geom.y2-e.geom.y1)/2),this.ctx.lineTo(e.geom.x2,e.geom.y2);break;case"bottom":this.ctx.moveTo(e.geom.x1,e.geom.y1),this.ctx.lineTo(e.geom.x2-(e.geom.x2-e.geom.x1)/2,e.geom.y2),this.ctx.lineTo(e.geom.x2,e.geom.y1);break;case"top":this.ctx.moveTo(e.geom.x1,e.geom.y2),this.ctx.lineTo(e.geom.x2-(e.geom.x2-e.geom.x1)/2,e.geom.y1),this.ctx.lineTo(e.geom.x2,e.geom.y2)}this.ctx.closePath(),this.ctx.stroke()}}updateCanvas(){this.canvas.width=this.canvas.clientWidth*this.dpi,this.canvas.height=this.canvas.clientHeight*this.dpi,this.node.factor=Math.min(Math.floor(this.canvas.width/(this.node.params.w+80)),Math.floor(this.canvas.height/(this.node.params.h+80))),this.node.invFactor=10/this.node.factor}update(){this.updateCanvas(),this.calcNode(this.node),this.scaleGeometry(this.node),this.calcOffset(this.node),this.calcHelpers(),this.drawNode(this.node),this.drawHelpers(),this.updateInputs()}init(){this.node?this.root?(this.root.appendChild(this.canvas),this.canvas.width=this.canvas.clientWidth*this.dpi,this.canvas.height=this.canvas.clientHeight*this.dpi,this.node.factor=Math.min(Math.floor(this.canvas.width/(this.node.params.w+80)),Math.floor(this.canvas.height/(this.node.params.h+80))),this.node.invFactor=10/this.node.factor,this.helpersSize*=this.node.factor,this.ctx=this.canvas.getContext("2d"),this.node.params.maxh||(this.node.params.maxh=1e3),this.node.params.minh||(this.node.params.minh=10),this.node.params.maxw||(this.node.params.maxw=1e3),this.node.params.minw||(this.node.params.minw=10),this.node.params.minCol||(this.node.params.minCol=[]),this.node.params.maxCol||(this.node.params.maxCol=[]),this.node.params.maxRow||(this.node.params.maxRow=[]),this.node.params.minRow||(this.node.params.minRow=[]),setTimeout(()=>{this.initInputs(),this.update()},200)):console.error("NO ROOT ELEMENT! Failed to init"):console.error("NO NODE OBJECT! Failed to init")}}document.addEventListener("DOMContentLoaded",()=>{let t=new WE("we-cont",win2);t.init(),console.log(t),addEventListener("resize",e=>{t.update()})});