let win1={params:{h:90,w:200,col:[50,40,60],row:[]},pd:[4,4,4,4],gap:4,dir:"v",child:[{gap:4,pd:[4,4,4,4],dir:"h",child:[{size:"col-1"},{size:"col-2"},{}]},{},{size:"col-1"}]},win2={params:{h:150,w:178,minh:120,maxh:220,minw:150,maxw:240,col:[40,60],row:[100],colOrder:[-1,1,0],rowOrder:[-1,0]},pd:[2,2,2,2],gap:2,dir:"v",child:[{pd:[3,3,3,3],child:[{glass:!0}]},{size:"row-0",gap:2,borderless:!0,child:[{pd:[3,3,3,3],child:[{glass:!0,triangle:"right"}]},{size:"col-1",pd:[3,3,3,3],child:[{glass:!0}]},{size:"col-0",pd:[3,3,3,3],child:[{glass:!0,triangle:"left"}]}]}]};class WE{constructor(t,e,s=2,i=18){this.helpersSize=i,this.helpers=[],this.node=e,this.dpi=s,this.root=document.getElementById(t),this.canvas=document.createElement("canvas"),this.hEl=document.createElement("input"),this.wEl=document.createElement("input"),this.tip=document.createElement("span"),this.colEl=[],this.rowEl=[],this.ctx=null}parseParam(t){var e=t.size.substring(0,t.size.indexOf("-")),t=t.size.substring(parseInt(t.size.indexOf("-")+1,t.size.length));if(this.node.params[e][t])return[this.node.params[e][t],e,t];console.warn("WRONG PARAMETER: dir "+e+" index "+t)}calcOffset(){this.node.oldOffsetX=this.node.offsetX,this.node.oldOffsetY=this.node.offsetY,this.node.offsetX=(this.canvas.width-(this.node.geom.x2-this.node.geom.x1))/2,this.node.offsetY=(this.canvas.height-(this.node.geom.y2-this.node.geom.y1))/2}scaleGeometry(t){for(var e in this.node.factor||(this.node.factor=this.node.dpi),t.geom)t.geom[e]*=this.node.factor;t.child&&t.child.forEach(t=>this.scaleGeometry(t))}calcNode(i,t=null,e=0){if(i.bb={x1:0,y1:0,x2:0,y2:0},i.geom={...i.bb},!i.dir&&i.child&&(i.dir="h"),!i.gap&&i.child&&(i.gap=0),i.pd||(i.pd=[0,0,0,0]),i){if(t?("h"==t.dir?(t.geom.x2,t.geom.x1,i.bb.y1=t.geom.y1,i.bb.y2=t.geom.y2,0<e?i.bb.x1+=t.child[e-1].bb.x2:i.bb.x1=t.geom.x1,"string"==typeof i.size?i.bb.x2=i.bb.x1+this.parseParam(i)[0]:i.bb.x2=i.bb.x1+t.autoSize):(t.geom.y2,t.geom.y1,i.bb.x1=t.geom.x1,i.bb.x2=t.geom.x2,0<e?i.bb.y1+=t.child[e-1].bb.y2:i.bb.y1=t.geom.y1,"string"==typeof i.size?i.bb.y2=i.bb.y1+this.parseParam(i)[0]:i.bb.y2=i.bb.y1+t.autoSize),i.geom={...i.bb},1<t.child.length?"h"==t.dir?(i.geom.y1+=t.pd[0],i.geom.y2-=t.pd[2],0==e&&(i.geom.x1+=t.pd[1]),e==t.child.length-1&&(i.geom.x2-=t.pd[3]),0<e&&(i.geom.x1+=t.gap/2),e<t.child.length-1&&(i.geom.x2-=t.gap/2)):(i.geom.x1+=t.pd[1],i.geom.x2-=t.pd[3],0==e&&(i.geom.y1+=t.pd[0]),e==t.child.length-1&&(i.geom.y2-=t.pd[2]),0<e&&(i.geom.y1+=t.gap/2),e<t.child.length-1&&(i.geom.y2-=t.gap/2)):(i.geom.x1+=t.pd[3],i.geom.x2-=t.pd[1],i.geom.y1+=t.pd[0],i.geom.y2-=t.pd[2])):(i.bb={x1:0,y1:0,x2:this.node.params.w,y2:this.node.params.h},i.geom={...i.bb}),i.child){let e=0,s=i.child.length;i.child.forEach(t=>{"string"==typeof t.size&&(e+=this.parseParam(t)[0],--s)}),"h"==i.dir?i.autoSize=(i.geom.x2-i.geom.x1-e)/s:i.autoSize=(i.geom.y2-i.geom.y1-e)/s,i.child&&i.child.forEach((t,e)=>this.calcNode(t,i,e))}}else console.error("NO NODE OBJECT! Failed to CalcNode")}drawHelpers(){this.ctx.strokeStyle="#000",this.ctx.fillStyle="#000",this.ctx.lineWidth=1.5*this.dpi,this.ctx.font=`bold ${24*this.dpi}px sans-serif`,this.ctx.textAlign="center",this.ctx.beginPath();let t=1;this.helpers.length&&(t*=2),this.ctx.moveTo(this.node.geom.x1,this.node.geom.y1),this.ctx.lineTo(this.node.geom.x1,this.node.geom.y1-this.helpersSize*t),this.ctx.moveTo(this.node.geom.x2,this.node.geom.y1),this.ctx.lineTo(this.node.geom.x2,this.node.geom.y1-this.helpersSize*t),this.ctx.moveTo(this.node.geom.x1,this.node.geom.y1-this.helpersSize*t*.95),this.ctx.lineTo(this.node.geom.x2,this.node.geom.y1-this.helpersSize*t*.95),this.ctx.moveTo(this.node.geom.x2,this.node.geom.y1),this.ctx.lineTo(this.node.geom.x2+this.helpersSize*t,this.node.geom.y1),this.ctx.moveTo(this.node.geom.x2,this.node.geom.y2),this.ctx.lineTo(this.node.geom.x2+this.helpersSize*t,this.node.geom.y2),this.ctx.moveTo(this.node.geom.x2+this.helpersSize*t*.95,this.node.geom.y1),this.ctx.lineTo(this.node.geom.x2+this.helpersSize*t*.95,this.node.geom.y2),this.helpers.forEach((t,e)=>{var s,i;"col"==t.dir&&(this.ctx.moveTo(t.pos*this.node.factor,this.node.geom.y1),this.ctx.lineTo(t.pos*this.node.factor,this.node.geom.y1-.95*this.helpersSize),this.ctx.moveTo((t.pos+t.value)*this.node.factor,this.node.geom.y1),this.ctx.lineTo((t.pos+t.value)*this.node.factor,this.node.geom.y1-.95*this.helpersSize),this.ctx.moveTo(t.pos*this.node.factor,this.node.geom.y1-.85*this.helpersSize),this.ctx.lineTo((t.pos+t.value)*this.node.factor,this.node.geom.y1-.85*this.helpersSize),"text"==t.type)&&(s=(t.pos+t.value/2)*this.node.factor,i=this.node.geom.y1-this.helpersSize/2+4*this.node.factor,this.ctx.fillText(t.value,s,i)),"row"==t.dir&&(this.ctx.moveTo(this.node.geom.x2,t.pos*this.node.factor),this.ctx.lineTo(this.node.geom.x2+.95*this.helpersSize,t.pos*this.node.factor),this.ctx.moveTo(this.node.geom.x2,(t.pos+t.value)*this.node.factor),this.ctx.lineTo(this.node.geom.x2+.95*this.helpersSize,(t.pos+t.value)*this.node.factor),this.ctx.moveTo(this.node.geom.x2+.85*this.helpersSize,t.pos*this.node.factor),this.ctx.lineTo(this.node.geom.x2+.85*this.helpersSize,(t.pos+t.value)*this.node.factor),"text"==t.type)&&(s=this.node.geom.x2+this.helpersSize/2.4,i=(t.pos+t.value/2)*this.node.factor+4*this.node.factor,this.ctx.fillText(t.value,s,i))}),this.ctx.closePath(),this.ctx.stroke()}setRelief(t=this.hEl){t.classList.remove("urgent"),this.tip.style.display="none"}setUrgent(t=this.hEl,e="min",s=100500){let i="";t.classList.add("urgent"),this.tip.style.top=t.style.top,this.tip.style.left=t.style.left,this.tip.style.display="block",i=i+("min"==e?"Min. ":"Max. ")+s,this.tip.innerHTML=i}validate(t,e,s,i){s=s||10;let h=0;return e<=(i=i||1e3)&&s<=e?(h=e,this.setRelief(t)):e<s?(setTimeout(()=>{this.setUrgent(t,"min",s)},50),h=s):i<e&&(setTimeout(()=>{this.setUrgent(t,"max",i)},50),h=i),h=parseInt(h),t.value=h}setParam(t="height",e=100,s=null){var i;"height"==t?s?"max"==s?this.hEl.max=this.params.maxh=e:this.hEl.min=this.params.minh=e:this.node.params.h=this.validate(this.hEl,e,this.node.params.minh,this.node.params.maxh):"width"==t?s?"max"==s?this.wEl.max=this.params.maxw=e:this.wEl.min=this.params.minw=e:this.node.params.w=this.validate(this.wEl,e,this.node.params.minw,this.node.params.maxw):(i=t.split("-")[0],t=t.split("-")[1],"col"==i&&(s?"max"==s?this.colEl[t].max=this.params.maxCol[t]=e:this.colEl[t].min=this.params.minCol[t]=e:this.node.params.col[t]=this.validate(this.colEl[t],e,this.node.params.minCol[t],this.node.params.maxCol[t])),"row"==i&&(s?"max"==s?this.rowEl[t].max=this.params.maxRow[t]=e:this.rowEl[t].min=this.params.minRow[t]=e:this.node.params.row[t]=this.validate(this.rowEl[t],e,this.node.params.minRow[t],this.node.params.maxRow[t]))),this.update()}updateInputs(){let i=this.node.params.w*this.node.factor/(2*this.dpi),h=this.node.params.h*this.node.factor/(2*this.dpi);this.wEl.style.top=`calc(50% - ${h+this.helpersSize}px)`,this.wEl.style.left=`calc(50% - ${i-this.node.params.w*(this.node.factor/this.dpi)/2}px)`,this.hEl.style.top="50%",this.hEl.style.left=`calc(50% - ${i-this.node.params.w/this.dpi*this.node.factor-this.helpersSize}px`,this.helpers.forEach((t,e)=>{var s;"input"==t.type&&(s=t.index,"col"==t.dir&&(this.colEl[s].style.left=`calc(50% - ${i-(this.helpers[e].pos+this.helpers[e].value/2)*this.node.factor/2}px)`,this.colEl[s].style.top=`calc(50% - ${h+this.helpersSize/2.2}px)`),"row"==t.dir)&&(this.rowEl[s].style.top=`calc(50% - ${h-(this.helpers[e].pos+this.helpers[e].value/2)*this.node.factor/2}px)`,this.rowEl[s].style.left=`calc(50% + ${i+this.helpersSize/2.4}px)`)})}initInputs(){this.wEl.value=this.node.params.w||10,this.wEl.setAttribute("id","we-width"),this.wEl.type="number",this.hEl.value=this.node.params.h||10,this.hEl.setAttribute("id","we-height"),this.hEl.type="number",isNaN(this.node.params.maxh)||(this.hEl.max=this.node.params.maxh),isNaN(this.node.params.minh)||(this.hEl.min=this.node.params.minh),isNaN(this.node.params.maxw)||(this.wEl.max=this.node.params.maxw),isNaN(this.node.params.minw)||(this.wEl.min=this.node.params.minw),this.tip.classList.add("tooltip"),this.tip.style.display="none",this.root.appendChild(this.hEl),this.root.appendChild(this.wEl),this.root.appendChild(this.tip),this.colEl.forEach(t=>{t.remove()}),this.rowEl.forEach(t=>{t.remove()}),this.colEl=[],this.rowEl=[],this.node.params.row.forEach((t,e)=>{this.rowEl.push(document.createElement("input")),this.rowEl[e].value=t,this.rowEl[e].type="number",this.rowEl[e].setAttribute("id","we-row-"+e),this.rowEl[e].addEventListener("blur",()=>{this.setRelief(this.rowEl[e])}),this.rowEl[e].addEventListener("change",t=>{this.setParam("row-"+e,t.target.value)}),this.root.appendChild(this.rowEl[e])}),this.node.params.col.forEach((t,e)=>{this.colEl.push(document.createElement("input")),this.colEl[e].value=t,this.colEl[e].type="number",this.colEl[e].setAttribute("id","we-col-"+e),this.colEl[e].addEventListener("blur",()=>{this.setRelief(this.colEl[e])}),this.colEl[e].addEventListener("change",t=>{this.setParam("col-"+e,t.target.value)}),this.root.appendChild(this.colEl[e])}),this.hEl.addEventListener("blur",()=>{this.setRelief(this.hEl)}),this.wEl.addEventListener("blur",()=>{this.setRelief(this.wEl)}),this.hEl.addEventListener("change",t=>{this.setParam("height",t.target.value)}),this.wEl.addEventListener("change",t=>{this.setParam("width",t.target.value)})}calcHelpers(){this.helpers=[],0<this.node.params.col.length&&(this.node.params.colOrder||(this.node.params.colOrder=Array.from(Array(this.node.params.col.length).keys()),this.node.params.colOrder.push(-1))),0<this.node.params.row.length&&(this.node.params.rowOrder||(this.node.params.rowOrder=Array.from(Array(this.node.params.row.length).keys()),this.node.params.rowOrder.push(-1))),this.node.params.colOrder.forEach((t,e)=>{var s,i={dir:"col"};t<0?(i.type="text",s=this.node.params.col.reduce((t,e)=>t+e,0),i.value=(this.node.params.w-s)/(this.node.params.colOrder.length-this.node.params.col.length)):(i.index=this.node.params.colOrder[e],i.type="input",i.value=this.node.params.col[t]);for(let t=i.pos=0;t<e;t++)i.pos+=this.helpers[t].value,i.inputPos=i.pos+i.value/2;this.helpers.push(i)}),this.node.params.rowOrder.forEach((t,e)=>{var s,i={dir:"row"};t<0?(i.type="text",s=this.node.params.row.reduce((t,e)=>t+e,0),i.value=(this.node.params.h-s)/(this.node.params.rowOrder.length-this.node.params.row.length)):(i.index=this.node.params.rowOrder[e],i.type="input",i.value=this.node.params.row[t]);for(let t=i.pos=0;t<e;t++)i.pos+=this.helpers[t+this.node.params.colOrder.length].value,i.inputPos=i.pos+i.value/2;this.helpers.push(i)})}drawNode(t,e=!0){e&&(this.ctx.translate(this.node.offsetX,this.node.offsetY),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)),this.ctx.strokeStyle="#000",this.ctx.lineWidth=1.5*this.dpi,this.ctx.fillStyle=`hsl(${t.bb.x2/t.bb.y2*360+3*t.bb.x1}deg, 60%, 70%)`,this.ctx.fillRect(t.geom.x1,t.geom.y1,t.geom.x2-t.geom.x1,t.geom.y2-t.geom.y1),t.borderless||this.ctx.strokeRect(t.geom.x1,t.geom.y1,t.geom.x2-t.geom.x1,t.geom.y2-t.geom.y1),t.child&&t.child.forEach(t=>this.drawNode(t,!1))}updateCanvas(){this.canvas.width=this.canvas.clientWidth*this.dpi,this.canvas.height=this.canvas.clientHeight*this.dpi,this.node.factor=Math.min(Math.floor(this.canvas.width/(this.node.params.w+80)),Math.floor(this.canvas.height/(this.node.params.h+80))),this.node.invFactor=10/this.node.factor}update(){this.updateCanvas(),this.calcNode(this.node),this.scaleGeometry(this.node),this.calcOffset(this.node),this.calcHelpers(),this.drawNode(this.node),this.drawHelpers(),this.updateInputs()}init(){this.node?this.root?(this.root.appendChild(this.canvas),this.canvas.width=this.canvas.clientWidth*this.dpi,this.canvas.height=this.canvas.clientHeight*this.dpi,this.node.factor=Math.min(Math.floor(this.canvas.width/(this.node.params.w+80)),Math.floor(this.canvas.height/(this.node.params.h+80))),this.node.invFactor=10/this.node.factor,this.helpersSize*=this.node.factor,this.ctx=this.canvas.getContext("2d"),this.node.params.maxh||(this.node.params.maxh=1e3),this.node.params.minh||(this.node.params.minh=10),this.node.params.maxw||(this.node.params.maxw=1e3),this.node.params.minw||(this.node.params.minw=10),this.node.params.minCol||(this.node.params.minCol=[]),this.node.params.maxCol||(this.node.params.maxCol=[]),this.node.params.maxRow||(this.node.params.maxRow=[]),this.node.params.minRow||(this.node.params.minRow=[]),setTimeout(()=>{this.initInputs(),this.update()},200)):console.error("NO ROOT ELEMENT! Failed to init"):console.error("NO NODE OBJECT! Failed to init")}}document.addEventListener("DOMContentLoaded",()=>{let e=new WE("we-cont",win2);e.init(),console.log(e),addEventListener("resize",t=>{e.update()})});